
<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Resumo do dia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); border-radius: 16px; }
    .btn { padding:.65rem 1rem; border-radius:.9rem; font-weight:700; }
    .pill { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; background:#0b1226; border:1px solid rgba(255,255,255,0.08); }
    .muted { opacity:.76; }
    a { color:#34d399; text-decoration: underline; }
  </style>
</head>
<body class="p-4">
  <div class="max-w-5xl mx-auto space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">üìä Resumo do dia</h1>
      <span id="tz" class="muted text-sm"></span>
    </header>

    <section id="loginCard" class="card p-4">
      <h2 class="font-semibold mb-2">Protegido por palavra-passe</h2>
      <p class="muted mb-3">Introduza a palavra-passe para ver o resumo de hoje.</p>
      <div class="flex gap-2 items-center">
        <input id="pw" type="password" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 w-64" placeholder="Palavra-passe" />
        <button id="enterBtn" class="btn bg-emerald-600 hover:bg-emerald-700">Entrar</button>
      </div>
      <p id="loginMsg" class="text-rose-400 text-sm mt-2"></p>
      </section>

    <section id="errorCard" class="hidden card p-4">
      <h2 class="font-semibold mb-2">‚ùó N√£o foi poss√≠vel ligar</h2>
      <p id="errText" class="text-rose-300 text-sm"></p>
    </section>

    <section id="sumCard" class="hidden card p-4">
      <div class="flex items-center justify-between gap-3 mb-3">
        <h2 class="font-semibold">Hoje <span id="rangeLbl" class="pill"></span></h2>
        <button id="refreshBtn" class="btn bg-slate-700 hover:bg-slate-600">Atualizar</button>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
        <div class="card p-3"><div class="muted text-xs">Encomendas</div><div id="cardCount" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="card p-3"><div class="muted text-xs">Confirmadas</div><div id="cardConf" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="card p-3"><div class="muted text-xs">Servidas</div><div id="cardServ" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="card p-3"><div class="muted text-xs">Total (CVE)</div><div id="cardTotal" class="text-2xl font-extrabold">‚Äî</div></div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="muted text-left">
            <tr><th class="p-2">Hora</th><th class="p-2">Mesa</th><th class="p-2">Estado</th><th class="p-2">Itens</th><th class="p-2">Total</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    document.getElementById('tz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';

    async function sha256Hex(s){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
      return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join('');
    }
    const formatCVE = n => `${Math.floor(Number(n)||0)}$00`;
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    const loginCard = document.getElementById('loginCard');
    const sumCard = document.getElementById('sumCard');
    const errorCard = document.getElementById('errorCard');
    const errText = document.getElementById('errText');
    const loginMsg = document.getElementById('loginMsg');

  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // --- Firebase init ---
    const firebaseConfig = {
      apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
      authDomain: "asabrancaff-faebe.firebaseapp.com",
      projectId: "asabrancaff-faebe",
      storageBucket: "asabrancaff-faebe.appspot.com",
      messagingSenderId: "326390762122",
      appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(()=>{});

    let HASH_DOC = { hash: null };
    async function getHash(){
      try{
        const snap = await getDoc(doc(db,'settings','resumo.sha256'));
        if (!snap.exists()){
          throw new Error("Configura√ß√£o em falta (settings/resumo.sha256)");
        }
        HASH_DOC = snap.data() || {};
        window.HASH_DOC = HASH_DOC;
        if (!HASH_DOC.hash || typeof HASH_DOC.hash !== 'string' || HASH_DOC.hash.length < 10){
          throw new Error("Campo 'hash' em settings/resumo.sha256 inv√°lido.");
        }
        return HASH_DOC.hash;
      }catch(e){
        const msg = (e && e.code === 'permission-denied')
          ? "Permiss√µes em falta para ler settings/resumo.sha256. Verifique as Regras do Firestore e se o Anonymous Auth est√° ativo."
          : (e.message || String(e));
        document.getElementById('errorCard').classList.remove('hidden');
        document.getElementById('errText').textContent = msg;
        throw e;
      }
    }

    // Date range for "today" (local timezone)
    function todayRange(){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
      const end   = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);
      return { start, end };
    }

    function computeTotal(o){
      if (typeof o.totalCVE === 'number') return Number(o.totalCVE)||0;
      let s=0; (o.items||[]).forEach(i=> s += Number(i.unitPrice||0)*Number(i.qty||1)); return s;
    }

    async function loadSummary(){
      const { start, end } = todayRange();
      const rangeLbl = document.getElementById('rangeLbl');
      rangeLbl.textContent = `${start.toLocaleDateString()} 00:00 ‚Äì ${end.toLocaleDateString()} 00:00`;

      const q = query(
        collection(db,'orders'),
        where('createdAt','>=', start),
        where('createdAt','<', end),
        orderBy('createdAt','desc')
      );
      const snap = await getDocs(q);
      const rows = []; snap.forEach(d=> rows.push({ id:d.id, ...d.data() }));

      const tbody = document.getElementById('rows'); tbody.innerHTML='';
      let count=0, conf=0, serv=0, total=0;
      rows.forEach(o=>{
        count++;
        if (o.confirmed) conf++;
        if (o.servedAt) serv++;
        total += computeTotal(o);

        const when = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleTimeString() : '';
        const itemsHtml = (o.items||[]).map(i => {
          const qty = Number(i.qty||1);
          const name = esc(i.name||'');
          const cat  = i.category ? `<span class="pill">${esc(i.category)}</span>` : '';
          return `${qty}√ó ${name} ${cat}`;
        }).join('<br>');

        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2">${when}</td>
                        <td class="p-2">${esc(o.table||'')}</td>
                        <td class="p-2">${o.servedAt? 'Servido' : (o.confirmed? 'Confirmado' : 'Pendente')}</td>
                        <td class="p-2">${itemsHtml}</td>
                        <td class="p-2 font-semibold">${formatCVE(computeTotal(o))}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('cardCount').textContent = count;
      document.getElementById('cardConf').textContent  = conf;
      document.getElementById('cardServ').textContent  = serv;
      document.getElementById('cardTotal').textContent = formatCVE(total);
    }
    window.loadSummary = loadSummary;

    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;
      try { await getHash(); } catch { return; } // show error card already
      // enable login
      const enterBtn = document.getElementById('enterBtn');
      enterBtn.addEventListener('click', async ()=>{
        const pw = document.getElementById('pw').value || '';
        const entered = await (await import('../')).default; // dummy to force top-level await? (ignored)
      });
    });

    // Hook login button without top-level await
    document.getElementById('enterBtn').addEventListener('click', async ()=>{
      try{
        const pw = document.getElementById('pw').value || '';
        if (!HASH_DOC.hash){
          await getHash(); // ensure we fetched
        }
        const digest = await (await import('https://cdn.skypack.dev/sha256-wasm?min')).sha256(pw); // fallback tiny lib
      }catch{ /* fallback to native */ }
    });
  </script>

  <script>
  // Final login glue WITHOUT external libs; compares sha256 and loads table
  (function(){
    async function sha256Hex(s){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
      return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join('');
    }
    async function doLogin(){
      const msg = document.getElementById('loginMsg');
      msg.textContent = '';
      try{
        if (!window.HASH_DOC || !window.HASH_DOC.hash){
          // HASH_DOC is module scope; but if module failed, fallback: inform user
          msg.textContent = 'N√£o foi poss√≠vel verificar configura√ß√£o. Veja a sec√ß√£o ‚öôÔ∏è acima.';
          return;
        }
        const pw = document.getElementById('pw').value || '';
        const h = await sha256Hex(pw);
        if (h !== window.HASH_DOC.hash){
          msg.textContent = 'Palavra-passe incorreta.';
          return;
        }
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('sumCard').classList.remove('hidden');
        // call loadSummary from module via global function proxy
        if (window.loadSummary) await window.loadSummary();
      }catch(e){
        msg.textContent = 'Erro no login. Verifique a configura√ß√£o.';
        console.warn(e);
      }
    }
    document.getElementById('enterBtn').addEventListener('click', doLogin);
    window.doLogin = doLogin;
  })();
  </script>
</body>
</html>
