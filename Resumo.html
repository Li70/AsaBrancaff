<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Resumo do Dia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); }
    .btn { padding:.6rem .9rem; border-radius:.9rem; font-weight:700; }
    .pill { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; background:#0b1226; border:1px solid rgba(255,255,255,0.08); }
    .table{ background:#111a34; border:1px solid rgba(255,255,255,0.08); border-radius:12px; display:flex; align-items:center; justify-content:center; height:56px; font-weight:700; cursor:pointer; transition:.15s; -webkit-tap-highlight-color: transparent; }
    .table.active{ outline:4px solid #22c55e; }
    .muted { opacity:.75; }
  </style>

</head>
<body class="p-6">
  <div class="max-w-3xl mx-auto space-y-4">
    <h1 class="text-2xl font-bold">Resumo do Dia</h1>
    <p class="muted">Protegido por palavra-passe. Configure em Firestore: <code>settings/resumo</code> → <code>{ sha256: "&lt;hash-hex&gt;" }</code>.</p>

    <div id="login" class="card p-4 rounded-2xl space-y-3">
      <label class="block text-sm muted">Palavra-passe</label>
      <input id="pwd" type="password" class="w-full px-3 py-2 rounded-xl bg-slate-800 border border-slate-700" placeholder="Introduza a palavra-passe" />
      <button id="enter" class="btn bg-emerald-700 hover:bg-emerald-600">Entrar</button>
      <div id="msg" class="text-sm text-rose-300"></div>
    </div>

    <div id="content" class="hidden space-y-4">
      <section class="card p-4 rounded-2xl">
        <div class="flex items-center justify-between">
          <span class="muted">Total faturado (hoje)</span>
          <strong id="grandTotal">0$00</strong>
        </div>
      </section>
      <section class="card p-4 rounded-2xl">
        <h2 class="font-semibold mb-2">Servidos hoje</h2>
        <div id="servedList" class="space-y-2"></div>
      </section>
    </div>
  </div>

  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getStorage, ref as sRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
    authDomain: "asabrancaff-faebe.firebaseapp.com",
    projectId: "asabrancaff-faebe",
    storageBucket: "asabrancaff-faebe.appspot.com",
    messagingSenderId: "326390762122",
    appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  signInAnonymously(auth).catch(()=>{});
  onAuthStateChanged(auth, ()=>{});

  window.__fb = { app, db, auth, storage, collection, doc, setDoc, addDoc, updateDoc, getDoc, onSnapshot, serverTimestamp, sRef, getDownloadURL };
</script>


  <script type="module">
    const { db, getDoc, doc, onSnapshot, collection, auth } = window.__fb;
    const formatCVE = n => `${Math.floor(Number(n)||0)}$00`;
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    async function ensureAuth(){
      try{
        if (auth.currentUser) return auth.currentUser;
        const mod = await import('https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js');
        const cred = await mod.signInAnonymously(auth);
        return cred.user;
      }catch(e){
        console.warn('Auth error: enable Anonymous Sign-in in Firebase Console', e);
        throw e;
      }
    }

    async function sha256hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function getHash(){
      try{ const snap=await getDoc(doc(collection(db,'settings'),'resumo')); return snap.exists()? String(snap.data().sha256||'') : ''; }catch(e){ console.warn(e); return ''; }
    }

    const login = document.getElementById('login'); const content = document.getElementById('content');
    const msg = document.getElementById('msg'); const pwd = document.getElementById('pwd');

    document.getElementById('enter').addEventListener('click', async ()=>{
      msg.textContent='';
      await ensureAuth();
      const stored = await getHash();
      if(!stored){ msg.textContent='Configuração em falta (settings/resumo.sha256).'; return; }
      const inputHash = await sha256hex(pwd.value||'');
      if (inputHash !== stored){ msg.textContent='Palavra-passe inválida.'; return; }
      login.classList.add('hidden'); content.classList.remove('hidden');
      await ensureAuth();
      startSummary();
    });

    function computeTotal(o){ if (typeof o.totalCVE === 'number') return Number(o.totalCVE)||0; let s=0; (o.items||[]).forEach(i=> s += Number(i.unitPrice||0)*Number(i.qty||1)); return s; }

    function startSummary(){
      const grandEl = document.getElementById('grandTotal'); const listEl = document.getElementById('servedList');
      const start = new Date(); start.setHours(0,0,0,0);
      onSnapshot(collection(db,'orders'), (snap)=>{
        const served = []; let total=0;
        snap.forEach(docSnap=>{ const d=docSnap.data(); if (d.servedAt && d.servedAt.toDate && d.servedAt.toDate() >= start){ served.push(d); total += Number(d.totalCVE||computeTotal(d)||0); } });
        grandEl.textContent = formatCVE(total);
        listEl.innerHTML='';
        served.sort((a,b)=> (b.servedAt?.seconds||0)-(a.servedAt?.seconds||0));
        served.forEach(o=>{
          const div=document.createElement('div'); div.className='flex items-start justify-between gap-3 p-2 bg-slate-800 rounded-xl';
          const items=(o.items||[]).map(i=>`${i.qty||1} × ${esc(i.name||i.pizzaType||'')}`).join('<br>');
          const when=o.servedAt?.toDate?o.servedAt.toDate().toLocaleTimeString():'';
          div.innerHTML=`<div><div class="font-semibold">Mesa ${esc(o.table)}</div><div class="muted text-sm leading-5">${items}</div><div class="muted text-xs mt-1">${when}</div></div><div class="font-bold">${formatCVE(Number(o.totalCVE||computeTotal(o)||0))}</div>`;
          listEl.appendChild(div);
        });
      }, (err)=>{
        msg.textContent = 'Permissões insuficientes para ler pedidos. Ver regras do Firestore.';
        console.error(err);
      });
    }
  </script>
</body>
</html>
