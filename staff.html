<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff — Pedidos</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#111; color:#eee}
    header{padding:12px 16px; background:#1b1b1b; position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center}
    .badge{background:#2a2a2a; padding:6px 10px; border-radius:999px; font-size:12px}
    #banner{display:none; background:#0b3; color:#fff; padding:8px 12px; border-radius:8px; margin-left:auto}
    main{padding:16px; display:grid; gap:12px}
    .card{background:#1b1b1b; border:1px solid #2a2a2a; border-radius:12px; padding:12px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .items{margin:8px 0 0 16px}
    button{background:#2d6cdf; color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer}
    button.secondary{background:#444}
    .muted{opacity:.7; font-size:12px}
  </style>
  <script>
    // Safe no-op guards (some older code references these)
    window.render = window.render || function(){};
    window.renderHistory = window.renderHistory || function(){};
  </script>
</head>
<body>
  <header>
    <div class="badge">Staff</div>
    <div id="counts" class="badge">—</div>
    <div id="banner">Pronto!</div>
    <audio id="readySound" preload="auto" loop>
      <source src="/ready.mp3" type="audio/mpeg">
      <source src="ready.mp3" type="audio/mpeg">
    </audio>
    <audio id="doneSound" preload="auto">
      <source src="/done.mp3" type="audio/mpeg">
      <source src="done.mp3" type="audio/mpeg">
    </audio>
  </header>
  <main id="list"></main>

  <!-- Firebase + realtime logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- Firebase config (from your project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
      authDomain: "asabrancaff-faebe.firebaseapp.com",
      projectId: "asabrancaff-faebe",
      storageBucket: "asabrancaff-faebe.appspot.com",
      messagingSenderId: "326390762122",
      appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
    };

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const ordersRef = collection(db, "orders");

    // --- UI refs ---
    const listEl = document.getElementById("list");
    const countsEl = document.getElementById("counts");
    const bannerEl = document.getElementById("banner");
    const readyEl = document.getElementById("readySound");
    const doneEl  = document.getElementById("doneSound");

    // --- Sound helpers ---
    let soundPrimed = false;
    function primeSound() {
      if (soundPrimed) return;
      soundPrimed = true;
      // try one quiet play/pause to unlock
      readyEl.volume = 0; doneEl.volume = 0;
      readyEl.play().then(()=>readyEl.pause()).catch(()=>{});
      doneEl.play().then(()=>doneEl.pause()).catch(()=>{});
      readyEl.volume = 1; doneEl.volume = 1;
    }
    function startReadyLoop() {
      primeSound();
      try { readyEl.currentTime = 0; readyEl.play().catch(()=>{}); } catch{}
    }
    function stopReadyLoop() {
      try { readyEl.pause(); readyEl.currentTime = 0; } catch{}
    }
    function playDoneOnce() {
      primeSound();
      try { doneEl.currentTime = 0; doneEl.play().catch(()=>{}); } catch{}
      try {
        bannerEl.textContent = "Pronto!";
        bannerEl.style.display = "block";
        setTimeout(()=> { bannerEl.style.display="none"; }, 2500);
      } catch{}
    }

    // --- State for edge-triggered sounds ---
    let prevPendingCount = 0;
    let prevReadyIds = new Set();

    // --- Render ---
    function esc(s){ const d=document.createElement("div"); d.textContent=String(s??""); return d.innerHTML; }
    function renderList(orders){
      listEl.innerHTML = "";
      if (!orders.length){
        listEl.innerHTML = '<div class="card muted">Sem pedidos.</div>';
        return;
      }
      for (const o of orders){
        const li = document.createElement("div");
        li.className = "card";
        const items = (Array.isArray(o.items)?o.items:[]).map(i=>`<li>${esc(i.qty??1)} × ${esc(i.name||i.item||i.pizzaType||"")}</li>`).join("") || '<li class="muted">—</li>';
        li.innerHTML = `
          <div class="row">
            <strong>Mesa ${esc(o.table??"?")}</strong>
            <div>
              ${o.confirmed ? '' : `<button data-action="confirm" data-id="${o.id}">Confirmar</button>`}
              <button class="secondary" data-action="served" data-id="${o.id}">Servido</button>
            </div>
          </div>
          <ul class="items">${items}</ul>
          ${o.notes ? `<div class="muted">Notas: ${esc(o.notes)}</div>` : ''}
        `;
        listEl.appendChild(li);
      }
    }

    // --- Button actions (event delegation) ---
    listEl.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      const ref = doc(ordersRef, id);
      try {
        if (action === "confirm") {
          await updateDoc(ref, { confirmed: true, confirmedAtMs: Date.now() });
        } else if (action === "served") {
          await updateDoc(ref, { served: true, servedAtMs: Date.now() });
        }
      } catch (e) { console.error(e); }
    });

    // --- Start realtime after auth ---
    onAuthStateChanged(auth, (u)=>{
      if (!u) return;
      onSnapshot(ordersRef, (snap)=>{
        const orders = [];
        const readyNow = new Set();
        let pendingCount = 0;

        snap.forEach(docSnap=>{
          const d = docSnap.data()||{};
          const o = {
            id: String(docSnap.id),
            table: d.table ?? null,
            items: Array.isArray(d.items) ? d.items : [],
            notes: d.notes || "",
            totalCVE: d.totalCVE || null,
            createdAtMs: d.createdAtMs || 0,
            confirmed: !!d.confirmed,
            confirmedAtMs: d.confirmedAtMs || null,
            isReady: !!d.isReady,
            readyAtMs: d.readyAtMs || null,
            served: !!d.served
          };
          if (!o.served) orders.push(o);
          if (!o.confirmed) pendingCount++;
          if (o.confirmed && !o.served && o.isReady === true) readyNow.add(o.id);
        });

        // Sort newest first for staff
        orders.sort((a,b)=> (b.createdAtMs||0)-(a.createdAtMs||0) || b.id.localeCompare(a.id));

        // Render
        renderList(orders);
        countsEl.textContent = `Pendentes: ${pendingCount} · Ativos: ${orders.length}`;

        // Sounds
        if (pendingCount > 0 && prevPendingCount === 0) startReadyLoop();
        if (pendingCount === 0 && prevPendingCount > 0) stopReadyLoop();
        prevPendingCount = pendingCount;

        // Done sound for new readies
        const newReady = [];
        readyNow.forEach(id => { if (!prevReadyIds.has(id)) newReady.push(id); });
        if (newReady.length > 0) playDoneOnce();
        prevReadyIds = readyNow;
      });
    });

    // Kick off anon auth
    signInAnonymously(auth).catch(()=>{});
  </script>
</body>
</html>
