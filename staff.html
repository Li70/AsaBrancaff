<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Staff · Pedidos (Firebase)</title>
  
<style>
  :root { color-scheme: light dark; --accent: #00897b; --bg:#0b0b0b; --card:#141414; --muted:#8a8a8a; }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background: var(--bg); color: #fff; }
  header { padding: 16px; background: #111; display: flex; gap: 12px; align-items:center; border-bottom: 1px solid #1e1e1e; position: sticky; top: 0; z-index: 5; }
  header h1 { margin: 0; font-size: 18px; font-weight: 600; }
  main { padding: 16px; display: grid; gap: 16px; max-width: 1100px; margin: 0 auto; }
  .card { background: var(--card); border: 1px solid #1e1e1e; border-radius: 16px; padding: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  input, textarea, select, button { background: #131313; color: #fff; border-radius: 10px; border: 1px solid #2a2a2a; padding: 10px 12px; font: inherit; }
  button { background: var(--accent); border: 0; cursor: pointer; }
  button.secondary { background: #2a2a2a; }
  .muted { color: var(--muted); font-size: 13px; }
  .list { display: grid; gap: 10px; }
  .item { border: 1px solid #262626; background: #121212; padding: 12px; border-radius: 12px; display: grid; gap: 8px; }
  .pill { font-size:12px; background:#1e1e1e; padding:4px 8px; border-radius:999px; }
  .split { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 800px){ .split { grid-template-columns: 1fr; } }
</style>

</head>
<body>
  <header>
    <h1>Staff</h1>
    <span class="pill">Confirmação & Serviço</span>
  </header>

  <main class="split">
    <section class="card">
      <h2 style="margin:0 0 10px 0;">Por confirmar</h2>
      <div id="pending" class="list"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px 0;">Confirmados</h2>
      <div id="confirmed" class="list"></div>
    </section>
  </main>

  
<!-- Firebase bootstrap (shared) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getStorage, ref as sRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
    authDomain: "asabrancaff-faebe.firebaseapp.com",
    projectId: "asabrancaff-faebe",
    storageBucket: "asabrancaff-faebe.appspot.com",
    messagingSenderId: "326390762122",
    appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
  };
  window.firebaseConfig = firebaseConfig;

  const app = initializeApp(window.firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  window.__fb = { app, db, auth, storage, collection, doc, addDoc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, sRef, getDownloadURL,
    ordersCol: collection(db, "orders")
  };
  window.__fbReady = false;
  onAuthStateChanged(auth, (u)=>{ if (u) { window.__fbReady = true; } });
  signInAnonymously(auth).catch(()=>{});
</script>


  <script type="module">
    const $ = s=>document.querySelector(s);

    let doneAudio = null;
    (async () => { try {
      const {storage, sRef, getDownloadURL} = window.__fb;
      const url = await getDownloadURL(sRef(storage, "audio/done.mp3"));
      doneAudio = new Audio(url);
    } catch(e){} })();

    function renderList(el, rows, type) {
      el.innerHTML = rows.map(o=>\`
        <div class="item">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>Mesa \${o.table} (\${o.items.length} itens)</strong>
            <span class="pill">\${o.isReady?'PRONTO':'—'}</span>
          </div>
          <div>Itens: \${o.items.join(', ')}</div>
          <div class="row">
            \${type==='pending' ? '<button class="confirm">Confirmar</button><button class="reject secondary">Rejeitar</button>' : '<button class="serve">Servido</button>'}
          </div>
          <div class="muted">#\${o.orderId} · \${new Date(o.createdAtMs).toLocaleTimeString()}</div>
        </div>
      \`).join("");

      Array.from(el.querySelectorAll(".confirm")).forEach((btn, i)=>btn.addEventListener("click", async (ev)=>{
        const id = rows[i].orderId;
        const {ordersCol, doc, updateDoc} = window.__fb;
        await updateDoc(doc(ordersCol, id), { confirmed: true, confirmedAt: Date.now() });
        try{ doneAudio && doneAudio.play().catch(()=>{}); }catch(e){}
      }));

      Array.from(el.querySelectorAll(".reject")).forEach((btn, i)=>btn.addEventListener("click", async (ev)=>{
        const id = rows[i].orderId;
        const {ordersCol, doc, updateDoc} = window.__fb;
        await updateDoc(doc(ordersCol, id), { rejectedAt: Date.now() });
      }));

      Array.from(el.querySelectorAll(".serve")).forEach((btn, i)=>btn.addEventListener("click", async (ev)=>{
        const id = rows[i].orderId;
        const {ordersCol, doc, updateDoc} = window.__fb;
        await updateDoc(doc(ordersCol, id), { servedAt: Date.now() });
      }));
    }

    function live() {
      const {ordersCol, onSnapshot, query, where} = window.__fb;
      const pendingQ = query(ordersCol,
        where("confirmed","==", false),
        where("rejectedAt","==", null)
      );
      const confirmedQ = query(ordersCol,
        where("confirmed","==", true),
        where("servedAt","==", null),
        where("rejectedAt","==", null)
      );

      onSnapshot(pendingQ, (snap)=>{
        const rows = []; snap.forEach(d=>rows.push(d.data()));
        rows.sort((a,b)=> (a.createdAtMs||0)-(b.createdAtMs||0));
        renderList(document.getElementById("pending"), rows, "pending");
      });

      onSnapshot(confirmedQ, (snap)=>{
        const rows = []; snap.forEach(d=>rows.push(d.data()));
        rows.sort((a,b)=> (a.createdAtMs||0)-(b.createdAtMs||0));
        renderList(document.getElementById("confirmed"), rows, "confirmed");
      });
    }

    live();
  </script>
</body>
</html>
