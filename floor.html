<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mesa · Pedidos (Firebase)</title>
  
<style>
  :root { color-scheme: light dark; --accent: #00897b; --bg:#0b0b0b; --card:#141414; --muted:#8a8a8a; }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background: var(--bg); color: #fff; }
  header { padding: 16px; background: #111; display: flex; gap: 12px; align-items:center; border-bottom: 1px solid #1e1e1e; position: sticky; top: 0; z-index: 5; }
  header h1 { margin: 0; font-size: 18px; font-weight: 600; }
  main { padding: 16px; display: grid; gap: 16px; max-width: 1100px; margin: 0 auto; }
  .card { background: var(--card); border: 1px solid #1e1e1e; border-radius: 16px; padding: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  input, textarea, select, button { background: #131313; color: #fff; border-radius: 10px; border: 1px solid #2a2a2a; padding: 10px 12px; font: inherit; }
  button { background: var(--accent); border: 0; cursor: pointer; }
  button.secondary { background: #2a2a2a; }
  .muted { color: var(--muted); font-size: 13px; }
  .list { display: grid; gap: 10px; }
  .item { border: 1px solid #262626; background: #121212; padding: 12px; border-radius: 12px; display: grid; gap: 8px; }
  .pill { font-size:12px; background:#1e1e1e; padding:4px 8px; border-radius:999px; }
  .split { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 800px){ .split { grid-template-columns: 1fr; } }
</style>

</head>
<body>
  <header>
    <h1>Pedidos · Sala</h1>
    <span class="pill">Firebase</span>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 10px 0;">Novo Pedido</h2>
      <div class="row">
        <label>Mesa<br><input id="table" placeholder="Ex.: 12" inputmode="numeric"></label>
        <label>Itens (vírgula separada)<br><input id="items" placeholder="Ex.: Café, Sandes mista, Sumol"></label>
        <label>Total (CVE)<br><input id="total" placeholder="Ex.: 450" inputmode="numeric"></label>
      </div>
      <label>Notas<br><textarea id="notes" rows="3" placeholder="Sem açúcar, alergia ao leite…"></textarea></label>
      <div class="row" style="margin-top:10px">
        <button id="send">Enviar pedido</button>
        <span class="muted" id="status">aguardando…</span>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0;">Meus últimos pedidos</h3>
      <div id="mine" class="list"></div>
    </section>
  </main>

  
<!-- Firebase bootstrap (shared) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getStorage, ref as sRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
    authDomain: "asabrancaff-faebe.firebaseapp.com",
    projectId: "asabrancaff-faebe",
    storageBucket: "asabrancaff-faebe.appspot.com",
    messagingSenderId: "326390762122",
    appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
  };
  window.firebaseConfig = firebaseConfig;

  const app = initializeApp(window.firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  window.__fb = { app, db, auth, storage, collection, doc, addDoc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, sRef, getDownloadURL,
    ordersCol: collection(db, "orders")
  };
  window.__fbReady = false;
  onAuthStateChanged(auth, (u)=>{ if (u) { window.__fbReady = true; } });
  signInAnonymously(auth).catch(()=>{});
</script>


  <script type="module">
    const $ = sel => document.querySelector(sel);

    // Optional: preload audio from Storage (plays on confirm updates)
    let audioConfirm = null;
    (async () => { try {
      const {storage, sRef, getDownloadURL} = window.__fb;
      const url = await getDownloadURL(sRef(storage, "audio/ready.mp3"));
      audioConfirm = new Audio(url);
    } catch(e){} })();

    $("#send").addEventListener("click", async () => {
      const table = $("#table").value.trim();
      const items = $("#items").value.split(",").map(s=>s.trim()).filter(Boolean);
      const notes = $("#notes").value.trim();
      const totalCVE = Number($("#total").value||0);
      if (!table || !items.length) { alert("Mesa e itens são obrigatórios."); return; }
      const orderId = String(Date.now());

      const payload = {
        orderId, table, items, notes, totalCVE,
        createdAtMs: Date.now(),
        confirmed: false,
        isReady: false,
        rejectedAt: null,
        servedAt: null
      };

      try {
        const {ordersCol, setDoc, doc} = window.__fb;
        await setDoc(doc(ordersCol, orderId), payload, { merge: true });
        $("#status").textContent = "Enviado ✔️";
        $("#items").value = ""; $("#notes").value = ""; $("#total").value = "";
      } catch (e) {
        console.error(e);
        $("#status").textContent = "Erro ao enviar";
      }
    });

    // Realtime view of the last 10 orders
    (function subscribeMine(){
      const {ordersCol, onSnapshot, query, orderBy} = window.__fb;
      const q = query(ordersCol, orderBy("createdAtMs","desc"));
      onSnapshot(q, (snap)=>{
        const rows = [];
        snap.forEach(d=> rows.push(d.data()));
        const top = rows.slice(0, 10);
        const root = document.getElementById("mine");
        root.innerHTML = top.map(o=>\`
          <div class="item">
            <div class="row" style="justify-content:space-between;align-items:center">
              <strong>Mesa \${o.table}</strong>
              <span class="pill">\${o.confirmed ? 'confirmado' : 'pendente'}</span>
            </div>
            <div>Itens: \${o.items.join(", ")}</div>
            <div class="muted">#\${o.orderId} · \${o.isReady ? 'pronto' : 'a preparar'}</div>
          </div>
        \`).join("");
        try{
          if (audioConfirm && top.some(o => o.confirmed)) {
            audioConfirm.play().catch(()=>{});
          }
        }catch(e){}
      });
    })();
  </script>
</body>
</html>
