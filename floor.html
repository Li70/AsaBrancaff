<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Floor — Nova Encomenda</title>
  <style>
    :root{
      --bg:#0f0f0f; --panel:#181818; --line:#2a2a2a; --text:#eee; --muted:#9aa3ab;
      --accent:#2d6cdf; --green:#11a34a; --danger:#b00020;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:var(--bg); color:var(--text)}
    header{padding:12px 16px; background:#121212; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:10}
    header .row{display:flex; align-items:center; gap:12px}
    main{max-width:980px; margin:16px auto; padding:0 16px; display:grid; gap:16px}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px}
    .row{display:flex; gap:12px; align-items:center}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{width:100%; background:#111; color:#eee; border:1px solid var(--line); border-radius:10px; padding:8px 10px}
    input[type=number]{appearance:textfield}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th, td{padding:6px 8px; text-align:left; vertical-align:middle}
    th{color:var(--muted); font-weight:600; font-size:12px}
    tbody tr{background:#141414; border:1px solid var(--line)}
    tbody tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}
    .actions{display:flex; gap:8px; align-items:center; justify-content:flex-end}
    button{background:var(--accent); color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer}
    button.secondary{background:#333}
    button.success{background:var(--green)}
    button.danger{background:var(--danger)}
    .muted{color:var(--muted)}
    .total{font-weight:700; font-size:18px}
    .banner{display:none; padding:10px 12px; border-radius:10px; background:#113b18; color:#b6ffc1}
    .error{display:none; padding:10px 12px; border-radius:10px; background:#3b1111; color:#ffc1c1}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <strong>Floor</strong>
      <span class="muted">Criar nova encomenda</span>
    </div>
  </header>

  <main>
    <div id="okBanner" class="banner">Encomenda enviada.</div>
    <div id="errBanner" class="error"></div>

    <section class="card">
      <div class="row" style="gap:16px; flex-wrap:wrap">
        <div style="flex:1; min-width:160px">
          <label for="tableInput">Mesa</label>
          <input id="tableInput" type="number" min="0" placeholder="nº da mesa" />
        </div>
        <div style="flex:2; min-width:260px">
          <label for="notesInput">Notas</label>
          <input id="notesInput" type="text" placeholder="sem cebola, pouco sal..." />
        </div>
      </div>
    </section>

    <section class="card">
      <table>
        <thead>
          <tr>
            <th style="width:80px">Qtd</th>
            <th>Item</th>
            <th style="width:180px">Categoria</th>
            <th style="width:140px">Preço (CVE)</th>
            <th style="width:80px"></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <div class="actions" style="margin-top:8px">
        <button id="addItemBtn" class="secondary" type="button">Adicionar item</button>
      </div>
    </section>

    <section class="card row" style="justify-content:space-between">
      <div class="muted">Total</div>
      <div id="totalEl" class="total">0$00</div>
    </section>

    <section class="actions">
      <button id="clearBtn" class="secondary" type="button">Limpar</button>
      <button id="submitBtn" class="success" type="button">Passar encomenda</button>
    </section>
  </main>

  <!-- Firebase Boot (v11) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
      authDomain: "asabrancaff-faebe.firebaseapp.com",
      projectId: "asabrancaff-faebe",
      storageBucket: "asabrancaff-faebe.appspot.com",
      messagingSenderId: "326390762122",
      appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
    };
    window.firebaseConfig = firebaseConfig;

    const app = initializeApp(window.firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    window.__fb = { app, db, auth, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where,
      ordersCol: collection(db, "orders")
    };
    window.__fbReady = false;
    onAuthStateChanged(auth, (u)=>{ if (u) { window.__fbReady = true; } });
    signInAnonymously(auth).catch(()=>{});
  </script>

  <!-- Floor logic -->
  <script>
    (function(){
      const itemsBody = document.getElementById("itemsBody");
      const addItemBtn = document.getElementById("addItemBtn");
      const submitBtn  = document.getElementById("submitBtn");
      const clearBtn   = document.getElementById("clearBtn");
      const totalEl    = document.getElementById("totalEl");
      const okBanner   = document.getElementById("okBanner");
      const errBanner  = document.getElementById("errBanner");
      const tableInput = document.getElementById("tableInput");
      const notesInput = document.getElementById("notesInput");

      function F(n){
        try{ return new Intl.NumberFormat('pt-CV',{style:'currency', currency:'CVE', maximumFractionDigits:0}).format(n||0); }
        catch{ return String(n||0) + '$00'; }
      }

      function addRow(data){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="number" class="qty" min="1" value="${data?.qty ?? 1}" /></td>
          <td><input type="text" class="name" placeholder="Nome do item" value="${data?.name ?? ''}" /></td>
          <td><input type="text" class="category" placeholder="Categoria (ex: Pratos)" value="${data?.category ?? ''}" /></td>
          <td><input type="number" class="price" min="0" step="1" value="${data?.price ?? ''}" /></td>
          <td><button type="button" class="danger remove">Remover</button></td>
        `;
        itemsBody.appendChild(tr);
      }

      function computeTotal(){
        let sum = 0;
        itemsBody.querySelectorAll("tr").forEach(tr=>{
          const qty = Number(tr.querySelector(".qty").value || 0);
          const price = Number(tr.querySelector(".price").value || 0);
          sum += qty * price;
        });
        totalEl.textContent = F(sum);
        return sum;
      }

      function readItems(){
        const list = [];
        itemsBody.querySelectorAll("tr").forEach(tr=>{
          const qty = Math.max(1, Number(tr.querySelector(".qty").value || 0));
          const name = String(tr.querySelector(".name").value || "").trim();
          const category = String(tr.querySelector(".category").value || "").trim();
          const price = Math.max(0, Number(tr.querySelector(".price").value || 0));
          if (name) list.push({ qty, name, category, price });
        });
        return list;
      }

      function showOk(msg="Encomenda enviada."){
        okBanner.textContent = msg;
        okBanner.style.display = "block";
        setTimeout(()=> okBanner.style.display="none", 2500);
      }
      function showErr(msg){
        errBanner.textContent = msg || "Erro ao enviar encomenda.";
        errBanner.style.display = "block";
        setTimeout(()=> errBanner.style.display="none", 3500);
      }

      // Events
      addItemBtn.addEventListener("click", ()=>{ addRow(); });
      itemsBody.addEventListener("input", ()=> computeTotal());
      itemsBody.addEventListener("click", (ev)=>{
        if (ev.target && ev.target.classList.contains("remove")){
          ev.target.closest("tr")?.remove();
          computeTotal();
        }
      });
      clearBtn.addEventListener("click", ()=>{
        itemsBody.innerHTML = ""; computeTotal();
        notesInput.value = ""; tableInput.value = "";
      });

      async function waitForFbReady(){
        for (let i=0;i<60;i++){
          if (window.__fb && window.__fbReady) return true;
          await new Promise(r=>setTimeout(r,200));
        }
        return !!window.__fb;
      }

      async function sendOrder(){
        submitBtn.disabled = true;
        try {
          if (!await waitForFbReady()){ throw new Error("Firebase não está pronto."); }
          const fb = window.__fb;
          const items = readItems();
          const table = Number(tableInput.value || 0);
          const notes = String(notesInput.value || "").trim();
          if (!table && table !== 0){ throw new Error("Indique a mesa."); }
          if (items.length === 0){ throw new Error("Adicione pelo menos um item."); }
          const total = computeTotal();

          const payload = {
            table,
            items,
            notes,
            totalCVE: total,
            createdAtMs: Date.now(),
            confirmed: false,
            confirmedAtMs: null,
            isReady: false,
            readyAtMs: null,
            served: false,
            servedAtMs: null
          };
          await fb.addDoc(fb.ordersCol, payload);
          showOk();
          // reset form
          itemsBody.innerHTML = "";
          addRow();
          notesInput.value = "";
          // keep table for next order
          computeTotal();
        } catch (e){
          console.error(e);
          showErr(e?.message || String(e));
        } finally {
          submitBtn.disabled = false;
        }
      }

      submitBtn.addEventListener("click", sendOrder);

      // Initial rows
      addRow();
      computeTotal();
    })();
  </script>
</body>
</html>
