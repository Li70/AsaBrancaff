<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cozinha – Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); }
    .btn { padding:.6rem .9rem; border-radius:.9rem; font-weight:700; }
    .pill { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; background:#0b1226; border:1px solid rgba(255,255,255,0.08); }
    .table{ background:#111a34; border:1px solid rgba(255,255,255,0.08); border-radius:12px; display:flex; align-items:center; justify-content:center; height:56px; font-weight:700; cursor:pointer; transition:.15s; -webkit-tap-highlight-color: transparent; }
    .table.active{ outline:4px solid #22c55e; }
    .muted { opacity:.75; }
  </style>

</head>
<body class="p-4">
  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Cozinha – Pedidos</h1>
      <div class="flex items-center gap-2">
        <button id="soundBtn" class="btn bg-emerald-700 hover:bg-emerald-600">Som ativo</button>
        <button id="refreshBtn" class="btn bg-slate-700 hover:bg-slate-600">Atualizar</button>
      </div>
    </div>

    <div id="orders" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
  </div>

  <audio id="cashSound" preload="auto" src="cash.mp3"></audio>

  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getStorage, ref as sRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
    authDomain: "asabrancaff-faebe.firebaseapp.com",
    projectId: "asabrancaff-faebe",
    storageBucket: "asabrancaff-faebe.appspot.com",
    messagingSenderId: "326390762122",
    appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  signInAnonymously(auth).catch(()=>{});
  onAuthStateChanged(auth, ()=>{});

  window.__fb = { app, db, auth, storage, collection, doc, setDoc, addDoc, updateDoc, getDoc, onSnapshot, serverTimestamp, sRef, getDownloadURL };
</script>


  <script type="module">
    const FB = window.__fb || {}; const { db, storage, onSnapshot, collection, doc, updateDoc, serverTimestamp, sRef, getDownloadURL } = FB;

    (async ()=>{ try{ const url = await getDownloadURL(sRef(storage,'cash.mp3')); document.getElementById('cashSound').src = url; }catch{} })();

    const cashEl = document.getElementById('cashSound');
    let soundEnabled=false;
    document.getElementById('soundBtn').addEventListener('click', ()=>{
      cashEl.play().then(()=>{ cashEl.pause(); cashEl.currentTime=0; soundEnabled=true; }).catch(()=>{});
    });

    const ordersDiv = document.getElementById('orders');
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

    function itemLine(i){
      const pill = i.category ? ` <span class="pill">${esc(i.category)}</span>` : '';
      return `${i.qty||1} × ${esc(i.name||i.pizzaType||'')}${pill}`;
    }

    function render(list){
      ordersDiv.innerHTML='';
      if(!list.length){ ordersDiv.innerHTML='<p class="muted">Sem pedidos confirmados.</p>'; return; }
      list.forEach(o=>{
        const items = (o.items||[]).map(itemLine).join('<br>') || '(sem itens)';
        const when = o.confirmedAt?.toDate ? o.confirmedAt.toDate().toLocaleTimeString() : '';
        const isReady = !!o.isReady;
        const card = document.createElement('div'); card.className='card p-3 rounded-xl';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold">Mesa ${esc(o.table)}</div>
              <div class="muted text-sm leading-5">${items}</div>
              ${o.notes?`<div class="text-sm mt-1">✍️ ${esc(o.notes)}</div>`:''}
              <div class="muted text-xs mt-1">Confirmado: ${when}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button class="btn ${isReady ? 'bg-emerald-900 opacity-80 cursor-not-allowed' : 'bg-emerald-700 hover:bg-emerald-600'}" data-done="${o._docId}">${isReady ? 'Pronto ✅' : 'Marcar pronto'}</button>
            </div>
          </div>`;
        const btn = card.querySelector('[data-done]');
        if (!isReady){
          btn.addEventListener('click', ()=>markDone(o));
        } else {
          btn.setAttribute('disabled','disabled');
        }
        ordersDiv.appendChild(card);
      });
    }

    async function markDone(o){
      try{ await updateDoc(doc(collection(db,'orders'), o._docId), { isReady:true, readyAt: serverTimestamp(), updatedAt: serverTimestamp() }); }catch(e){ console.warn(e); }
    }

    let prevIds = new Set();
    onSnapshot(collection(db,'orders'), (snap)=>{
      const list=[]; snap.forEach(docSnap=>{ const d=docSnap.data(); d._docId=docSnap.id; if (d.confirmed && !d.rejectedAt && !d.servedAt) list.push(d); });
      list.sort((a,b)=> (b.updatedAt?.seconds||0) - (a.updatedAt?.seconds||0));
      const ids = new Set(list.map(o=>o._docId)); let play=false; ids.forEach(id=>{ if(!prevIds.has(id)) play=true; }); prevIds = ids;
      if (play && soundEnabled){ try{ cashEl.currentTime=0; cashEl.play().catch(()=>{});}catch{} }
      render(list);
    }, (err)=>{
      console.error('Kitchen onSnapshot error:', err);
      alert('Erro a ler encomendas (permissões?). Ver consola.');
    });

    document.getElementById('refreshBtn').addEventListener('click', ()=>location.reload());
  </script>
</body>
</html>
