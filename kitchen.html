<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cozinha – Pedidos (Só Visualização)</title>
  <script src="https://cdn.tailwindcss.com"></script> 
<!-- <link rel="stylesheet" href="tailwind-lite.css"> -->
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); }
    .muted { color: rgba(255,255,255,0.7); }
    .btn  { padding:.55rem .85rem; border-radius:.75rem; font-weight:600; }
    .items li { list-style: disc; margin-left: 1.25rem; }
    details summary { cursor: pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/parse/dist/parse.min.js"></script>

  <script>
    try{
      Parse.initialize("90sppp5j95h77WJUAKKrSeVSFmRP2XgnUMxjzUaA", "B6F4JPeWDsVflznOWDEgD0IvVGxl2ZgtL5wycbcZ");
      Parse.serverURL="https://parseapi.back4app.com";
      Parse.liveQueryServerURL="wss://asabrancaff.b4a.io";
    }catch(e){ console && console.warn && console.warn('Parse init failed', e); }
  </script>

</head>
<body class="p-4">
  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Pedidos da Cozinha (Só Visualização)</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 cursor-pointer select-none flex items-center gap-2">
          <input id="hideServedChk" type="checkbox" /> Ocultar servidos
        </label>
        <button id="clearServedBtn" class="btn bg-slate-700 hover:bg-slate-600">Limpar servidos</button>
        <button id="soundBtn" class="btn bg-emerald-700 hover:bg-emerald-600">Som ativo</button>
      </div>
    </div>

    <div id="banner" class="hidden mb-3 p-3 rounded-xl bg-emerald-800/40 border border-emerald-700 text-sm">
      Novo pedido recebido!
    </div>

    <div id="orders" class="space-y-3 mb-6"></div>

   

  <!-- coloque cash.mp3 na mesma pasta ou troque por um URL -->
  <audio id="cashSound" preload="auto" src="cash.mp3"></audio>

  <script>
    "use strict";

    /* ====== Compatibilidade com dois formatos ====== */
    const KEYS = [
      { store: 'orders_simple_v4', version: 'orders_simple_v4_ver', channel: 'orders_simple_v4' },
      { store: 'orders',           version: 'orders_version',       channel: 'pizzaOrders' }
    ];

    function safeParse(json){ try { return JSON.parse(json || '[]'); } catch { return []; } }
    function uniqById(arr){
      const seen = new Set(); const out = [];
      for (const o of arr){
        const id = String((o && o.id) || o.createdAt || Math.random());
        if (!seen.has(id)){ seen.add(id); out.push(o); }
      }
      return out;
    }

    /* ====== CHANGED: only return CONFIRMED orders ====== */
    function getAllOrders(){
      const all = [];
      for (const k of KEYS) all.push(...safeParse(localStorage.getItem(k.store)));

      // Only orders confirmed by Staff should be visible to Kitchen.
      // Accept current shape (confirmed/confirmedAt) and legacy (status: 'confirmed').
      const confirmedOnly = all.filter(o => {
        const isConfirmed = o && (o.confirmed === true || !!o.confirmedAt || o.status === 'confirmed');
        return !!isConfirmed;
      });

      return uniqById(confirmedOnly).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    }

    /* ====== BroadcastChannels ====== */
    const channels = [];
    for (const k of KEYS){ try { channels.push(new BroadcastChannel(k.channel)); } catch {} }

    /* ====== UI refs ====== */
    const ordersDiv      = document.getElementById('orders');
    const banner         = document.getElementById('banner');
    const soundBtn       = document.getElementById('soundBtn');
    const cashEl         = document.getElementById('cashSound');
    const hideServedChk  = document.getElementById('hideServedChk');
    const clearServedBtn = document.getElementById('clearServedBtn');
    const histList       = document.getElementById('histList');
    const histTotalEl    = document.getElementById('histTotal');

    /* ====== Estado "Servido" (persistente) + versão ====== */
    const SERVED_KEY = 'orders_served';
    const SERVED_VERSION = 'orders_served_ver';
    function loadServed(){ try { return JSON.parse(localStorage.getItem(SERVED_KEY) || '{}'); } catch { return {}; } }
    function saveServed(map){
      localStorage.setItem(SERVED_KEY, JSON.stringify(map));
      localStorage.setItem(SERVED_VERSION, String(Date.now())); // trigger storage
    }
    let servedMap = loadServed();

    /* ====== Histórico (vincula quando marca “Servido”) ====== */
    const HISTORY_KEY = 'orders_history_v1';
    function getHistory(){ try { return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); } catch { return []; } }
    function setHistory(v){ localStorage.setItem(HISTORY_KEY, JSON.stringify(v)); }
    function formatCVE(n){ return `${Math.floor(Number(n)||0)}$00`; }

    function computeTotal(order){
      if (typeof order.totalNum === 'number'){
        return { num: order.totalNum, text: order.totalText || formatCVE(order.totalNum) };
      }
      let ok=false, sum=0;
      for (const it of (order.items||[])){
        if (typeof it.unitPrice === 'number'){ ok=true; sum += (it.unitPrice||0) * (Number(it.qty||1)); }
      }
      return ok ? { num: sum, text: formatCVE(sum) } : { num: null, text: null };
    }

    function ensureHistoryEntry(order, served){
      if (!served) return; // só regista quando fica servido
      const id = String(order.id);
      const hist = getHistory();
      if (!hist.some(h => String(h.id) === id)){
        const t = computeTotal(order);
        hist.push({
          id,
          table: order.table,
          createdAt: order.createdAt || Date.now(),
          servedAt: Date.now(),
          totalNum: t.num,
          totalText: t.text,
          items: (order.items||[]).map(i=>({ name: i.pizzaType||'', qty: Number(i.qty||1), unitPrice: i.unitPrice||null }))
        });
        setHistory(hist);
      }
      renderHistory(); // update panel
    }

    function isToday(ts){
      const d = new Date(ts || Date.now());
      const now = new Date();
      return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
    }

    function renderHistory(){
      const hist = getHistory().filter(h => isToday(h.servedAt || h.createdAt));
      histList.innerHTML = '';
      if (!hist.length){
        histList.innerHTML = '<p class="muted">Sem registos hoje.</p>';
      } else {
        let total = 0;
        hist.forEach(h=>{
          if (typeof h.totalNum === 'number') total += h.totalNum||0;
          const when = h.servedAt ? new Date(h.servedAt).toLocaleTimeString() : '';
          const ttxt = (h.totalText) ? h.totalText : (typeof h.totalNum==='number' ? formatCVE(h.totalNum) : '—');
          const div = document.createElement('div');
          div.className = 'card p-2 rounded-xl flex items-center justify-between';
          div.innerHTML = `
            <div>
              <div class="font-semibold">Mesa ${escapeHtml(h.table)}</div>
              <div class="muted text-xs">${when}</div>
            </div>
            <div class="font-semibold">${ttxt}</div>
          `;
          histList.appendChild(div);
        });
        histTotalEl.textContent = formatCVE(total);
      }
    }

    /* ====== Som (auto-ativado) ====== */
    let soundEnabled = false, audioCtx;
    async function enableSound(){
      soundEnabled = true;
      try { cashEl.volume = 1; cashEl.muted = false; cashEl.currentTime = 0; await cashEl.play(); cashEl.pause(); cashEl.currentTime = 0; } catch {}
      // teste curto silencioso
      try { await cashEl.play(); setTimeout(()=>{ try{ cashEl.pause(); }catch{} }, 200); } catch {}
    }
    async function playSound(){
      if (!soundEnabled) return;
      try { cashEl.currentTime = 0; await cashEl.play(); return; } catch {}
      playFallback();
    }
    function playFallback(){
      if (!soundEnabled) return;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!audioCtx && Ctx) audioCtx = new Ctx();
      if (!audioCtx) return;
      const now = audioCtx.currentTime, g = audioCtx.createGain();
      const o1 = audioCtx.createOscillator(), o2 = audioCtx.createOscillator();
      o1.type='square'; o2.type='square'; o1.frequency.value=800; o2.frequency.value=1600;
      o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.45, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.55);
      o1.start(now); o2.start(now+0.08); o1.stop(now+0.57); o2.stop(now+0.57);
    }
    soundBtn.addEventListener('click', enableSound);

    // tentar ativar som por omissão
    document.addEventListener('DOMContentLoaded', enableSound);
    document.addEventListener('pointerdown', ()=>{ if (!soundEnabled) enableSound(); }, { once:true });
    document.addEventListener('keydown', ()=>{ if (!soundEnabled) enableSound(); }, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible' && !soundEnabled) enableSound(); });

    /* ====== Utils ====== */
    function escapeHtml(str){
      return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function showBanner(count){
      banner.textContent = count === 1 ? 'Novo pedido recebido!' : `${count} novos pedidos recebidos!`;
      banner.classList.remove('hidden');
      clearTimeout(showBanner._t);
      showBanner._t = setTimeout(()=> banner.classList.add('hidden'), 3000);
    }

    /* ====== Notificar Staff quando "Servido" muda ====== */
    function notifyServed(id, served){
      channels.forEach(ch => {
        try { ch.postMessage({ type: 'served_update', id, served }); } catch {}
      });
      // storage "versão" já feito em saveServed()
    }

    /* ====== Render ====== */
    let knownIds = new Set();

    function render({withAlerts=true} = {}){
      const orders = getAllOrders(); // ← agora só confirmados
      const currIds = new Set(orders.map(o => String(o.id)));
      let novos = 0;
      currIds.forEach(id => { if (!knownIds.has(id)) novos++; });

      ordersDiv.innerHTML = '';
      const hideServed = hideServedChk.checked;

      if (!orders.length){
        ordersDiv.innerHTML = '<p class="muted">Sem pedidos ainda.</p>';
      } else {
        orders.forEach(o => {
          const id = String(o.id);
          const quando = o.createdAt ? new Date(o.createdAt).toLocaleString() : '';
          const isServed = !!servedMap[id];
          if (hideServed && isServed) return;

          const div = document.createElement('div');
          div.className = 'card p-3 rounded-xl';

          const items = Array.isArray(o.items) ? o.items : [];
          const itemsHTML = items.map(i => {
            const qty = Number(i.qty||1);
            const name = escapeHtml(i.pizzaType||'');
            const note = i.notes ? ` <span class="muted">(${escapeHtml(i.notes)})</span>` : '';
            return `<li>${qty} × ${name}${note}</li>`;
          }).join('') || '<li class="muted">—</li>';

          const t = (typeof o.totalNum === 'number') ? (o.totalText || formatCVE(o.totalNum)) : '';
          const left = document.createElement('div');
          left.innerHTML = `
            <div class="font-semibold">Mesa ${escapeHtml(o.table ?? '?')}</div>
            <ul class="items mt-2">${itemsHTML}</ul>
            ${o.notes ? `<div class='text-sm mt-2'>✍️ ${escapeHtml(o.notes)}</div>` : ''}
            ${t ? `<div class="mt-2"><span class="muted text-xs">Total:</span> <b>${t}</b></div>` : ''}
          `;

          const right = document.createElement('div');
          right.className = 'flex flex-col items-end gap-2';
          right.innerHTML = `<div class="muted text-xs">${quando}</div>`;

          const label = document.createElement('label');
          label.className = 'flex items-center gap-2 text-sm cursor-pointer select-none';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox'; checkbox.checked = isServed;
          checkbox.addEventListener('change', () => {
            servedMap[id] = checkbox.checked;
            saveServed(servedMap);

            notifyServed(id, checkbox.checked);
            ensureHistoryEntry(o, checkbox.checked);   // <— regista no histórico
            render({withAlerts:false});
          });

          label.appendChild(checkbox);
          label.appendChild(document.createTextNode('Pronto'));
          right.appendChild(label);

          const row = document.createElement('div');
          row.className = 'flex items-start justify-between gap-3';
          row.appendChild(left); row.appendChild(right);
          if (isServed) row.classList.add('opacity-50');

          div.appendChild(row);
          ordersDiv.appendChild(div);
        });
      }

      if (withAlerts && novos > 0){ showBanner(novos); playSound(); }
      knownIds = currIds;
      renderHistory();
    }

    /* ====== Eventos ====== */
    hideServedChk.addEventListener('change', ()=>render({withAlerts:false}));
    clearServedBtn.addEventListener('click', ()=>{
      const ids = Object.keys(servedMap).filter(id => servedMap[id]);
      if (!ids.length) { alert('Não há pedidos marcados como servidos.'); return; }
      if (!confirm(`Limpar marcação de ${ids.length} pedido(s)?`)) return;
      ids.forEach(id => delete servedMap[id]);
      saveServed(servedMap);
      render({withAlerts:false});
    });

    channels.forEach(ch => ch.onmessage = ()=> render({withAlerts:true}));
    window.addEventListener('storage', (e)=>{
      if (!e.key) return;
      if (['orders_simple_v4','orders_simple_v4_ver','orders_served_ver', 'orders_history_v1'].includes(e.key)){
        render({withAlerts:true});
      }
    });

    setInterval(()=>render({withAlerts:true}), 1000);
    render({withAlerts:false});

    /* ====== Som ====== */
    function playSound(){
      if (!soundEnabled) return;
      cashEl.currentTime = 0;
      cashEl.play().catch(playFallback);
    }
  </script>








<!-- KITCHEN_SERVED_VIRTUAL_RO_V1 -->
<script>
(function(){
  var SERVED_KEY = 'orders_served';
  var SERVED_VERSION = 'orders_served_version';
  var _get = null;
  try{ _get = localStorage.getItem.bind(localStorage); }catch(e){}
  function servedMapFromCloud(){
    try{
      var arr = Array.isArray(window.__kCloudList) ? window.__kCloudList : [];
      var m = {}; arr.forEach(function(o){ m[String(o.id)] = !!o.isReady; });
      return m;
    }catch(e){ return {}; }
  }
  localStorage.getItem = function(k){
    try{
      if (k===SERVED_KEY){ return JSON.stringify(servedMapFromCloud()); }
      if (k===SERVED_VERSION){ return String(Date.now()); }
    }catch(e){}
    return _get ? _get(k) : null;
  };
})();
</script>





<!-- REMOVE_FILTERTABLE_V2 -->
<script>
(function(){
  function run(){
    try{
      var el = document.getElementById('filterTable');
      if (el && el.parentNode) el.parentNode.removeChild(el);
      var lbl = document.querySelector('label[for="filterTable"]');
      if (lbl && lbl.parentNode) lbl.parentNode.removeChild(lbl);
    }catch(e){}
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
  else run();
})();
</script>


<!-- KITCHEN_CLOUD_ONLY_V3B -->
<script>
(function(){
  if (!(window.Parse && Parse.applicationId)) return;
  const Order = Parse.Object.extend('Order');
  const ORDERS_KEY = (typeof window.ORDERS_KEY!=='undefined')? window.ORDERS_KEY : 'orders_simple_v4';
  const VERSION_KEY = (typeof window.VERSION_KEY!=='undefined')? window.VERSION_KEY : 'orders_simple_v4_ver';

  (function(){
    const _get = localStorage.getItem.bind(localStorage);
    window.__kCloudList = []; window.__kCloudVer = Date.now();
    localStorage.getItem = function(k){
      if (k===ORDERS_KEY) return JSON.stringify(window.__kCloudList);
      if (k===VERSION_KEY) return String(window.__kCloudVer);
      return _get(k);
    };
    window.__kApply = function(list,withAlerts){ try{ list = (list||[]).map(function(x){ return (x && x.id && x.items) ? x : toPlain(x); }); }catch(e){}
      window.__kCloudList=list; window.__kCloudVer=Date.now(); try{ if (typeof render==='function') render({withAlerts:!!withAlerts}); }catch(e){} };
  })();

  function toPlain(o){ return { id:String(o.get('orderId')||o.id), table:String(o.get('table')||''), items:o.get('items')||[], notes:String(o.get('notes')||''), confirmed:!!o.get('confirmed'), isReady:!!o.get('isReady'),
      createdAt:o.get('createdAtMs') || (o.createdAt? o.createdAt.getTime(): Date.now()), servedAt:o.get('servedAt')? (new Date(o.get('servedAt')).getTime()) : null, rejectedAt:o.get('rejectedAt')? (new Date(o.get('rejectedAt')).getTime()) : null }; }
  function pickBetter(a,b){ try{ if (!!a.get('confirmed')!==!!b.get('confirmed')) return a.get('confirmed')?a:b; if (!!a.get('isReady')!==!!b.get('isReady')) return a.get('isReady')?a:b; const au=a.updatedAt? a.updatedAt.getTime():0, bu=b.updatedAt? b.updatedAt.getTime():0; if (au!==bu) return au>bu?a:b; }catch(e){} return a; }
  function coalesceById(list){ const m=new Map(); (list||[]).forEach(o=>{ const id=String(o.get('orderId')||o.id); const cur=m.get(id); m.set(id, cur? pickBetter(cur,o): o); }); return Array.from(m.values()); }

  async function refreshAll(playAlerts){
    try{
      const q=new Parse.Query(Order);
      q.equalTo('confirmed', true); q.doesNotExist('servedAt'); q.doesNotExist('rejectedAt');
      q.limit(1000);
      const res=await q.find();
      const best = coalesceById(res).map(toPlain);
      window.__kApply(best, !!playAlerts);
}catch(e){}
  }
  async function live(){ try{ const q=new Parse.Query(Order); const sub=await q.subscribe(); const ref=()=>refreshAll(true); sub.on('create', ref); sub.on('update', ref); sub.on('delete', ref);}catch(e){} }
  function poll(){ setInterval(()=>refreshAll(false), 5000); }

  function updateLocalReadyFromMap(map){
    try{
      const arr = Array.isArray(window.__kCloudList) ? window.__kCloudList : [];
      arr.forEach(function(o){ if (Object.prototype.hasOwnProperty.call(map, String(o.id))) o.isReady = !!map[String(o.id)]; });
      window.__kApply(arr, false);
    }catch(e){}
  }

  (function(){
    const orig = window.saveServed;
    if (!orig) return;
    window.saveServed = function(map){
      (async ()=>{
        try{
          for (const id in (map||{})){
            if (!Object.prototype.hasOwnProperty.call(map,id)) continue;
            const ready = !!map[id];
            const q=new Parse.Query(Order); q.equalTo('orderId', String(id)); q.limit(10);
            const res=await q.find();
            if (res && res.length){
              for (const obj of res){
                if (!!obj.get('isReady') !== ready){
                  obj.set('isReady', ready);
                  await obj.save();
                }
              }
            }
          }
          updateLocalReadyFromMap(map); // instant checkbox sync locally
        }catch(e){}
      })();
      return orig.apply(this, arguments);
    };
  })();

  refreshAll(false); live(); poll();
})();
</script>

</body>
</html>
