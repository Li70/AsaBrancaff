<!DOCTYPE html>
<html lang="pt">
<head>
<link rel="icon" href="data:,">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cozinha</title>
<style>
  :root { --bg:#0b1020; --card:#111936; --muted:#7280a7; --ink:#e7ecff; --accent:#7aa2ff; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  header { position:sticky; top:0; z-index:5; padding:12px 16px; background:linear-gradient(180deg, rgba(11,16,32,.98), rgba(11,16,32,.65)); border-bottom:1px solid rgba(114,128,167,.25); display:flex; gap:12px; align-items:center; }
  header h1 { font-size:18px; margin:0; flex:1; font-weight:700; letter-spacing:.2px; }
  .wrap { max-width:1000px; margin: 16px auto; padding: 0 16px 24px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .card { background:var(--card); border:1px solid rgba(114,128,167,.25); border-radius:14px; padding:14px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
  .pill { border:1px solid rgba(114,128,167,.35); padding:6px 10px; border-radius:999px; font-size:12px; color:#cdd6ff; }
  .btn { background:#1b2a55; color:#e7ecff; border:1px solid rgba(114,128,167,.35); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; }
  .btn:active { transform: translateY(1px); }
  .btn-primary { background: var(--accent); color:#0a1022; border-color: transparent; }
  .btn-warn { background:#ffb44d; color:#241400; border-color:transparent; }
  .btn-ghost { background: transparent; color:#9fb1ff; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:12px; }
  .item { background: rgba(122,162,255,.08); border:1px dashed rgba(122,162,255,.35); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:6px; }
  .item h4 { margin:0; font-size:14px; line-height:1.2; }
  small.muted { color: var(--muted); }
  .qty { display:flex; gap:6px; align-items:center; }
  .qty button { width:28px; height:28px; border-radius:8px; }
  .cart { display:flex; flex-direction:column; gap:8px; }
  .cart-row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; background:rgba(122,162,255,.07); border:1px solid rgba(114,128,167,.25); border-radius:10px; }
  .total { font-size:16px; font-weight:800; }
  .tabs { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 12px; }
  .tab { padding:8px 12px; border-radius:999px; border:1px solid rgba(114,128,167,.35); cursor:pointer; }
  .tab.active { background:var(--accent); color:#0a1022; border-color:transparent; }
  .order { padding:12px; border:1px solid rgba(114,128,167,.25); border-radius:12px; margin-bottom:10px; background:rgba(122,162,255,.06); }
  .order h3 { margin:0 0 8px 0; font-size:15px; }
  .badges { display:flex; gap:8px; align-items:center; }
  .badge { padding:4px 8px; border-radius:999px; background:#223160; color:#c9d7ff; font-size:12px; border:1px solid rgba(114,128,167,.35) }
  .ready { background:#2e7040; color:#eafff0; }
  .new { background:#3d3a77; }
  .confirmed { background:#3c5d99; }
  .row-spread { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .muted { color:var(--muted); }
  .note { margin-top:8px; font-size:12px; color:#cbd4ff; opacity:.9 }
</style>
<!-- Firebase core (your project) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
    authDomain: "asabrancaff-faebe.firebaseapp.com",
    projectId: "asabrancaff-faebe",
    storageBucket: "asabrancaff-faebe.appspot.com",
    messagingSenderId: "326390762122",
    appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
  };
  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);
  signInAnonymously(auth).catch(()=>{});
  onAuthStateChanged(auth, ()=>{});

  // expose
  window.__fb = { app, db, auth, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where };
</script>
</head>
<body>
<header>
  <h1>Asa Branca Â· Cozinha</h1>
  <button id="soundBtn" class="btn btn-ghost">ðŸ”Š ativar som</button>
</header>
<div class="wrap">
  <div id="orders"></div>
</div>

<audio id="sndCash" src="cash.mp3" preload="auto"></audio>

<script>
(async function(){
  async function waitForFB(){
    if (window.__fb && window.__fb.db) return window.__fb;
    return await new Promise((resolve)=>{
      const started = Date.now();
      const t = setInterval(()=>{
        if (window.__fb && window.__fb.db){ clearInterval(t); resolve(window.__fb); }
        else if (Date.now()-started>6000){ clearInterval(t); resolve(window.__fb||{}); }
      }, 50);
    });
  }

  const fb = await waitForFB();
  let soundOk=false;
  document.getElementById('soundBtn').addEventListener('click', ()=>{ document.getElementById('sndCash').play().catch(()=>{}); soundOk=true; });

  function rowHTML(o){
    const items = (o.items||[]).map(it=>`<li>${it.qty}Ã— ${it.name} <small class="muted">(${it.category})</small> â€” <strong>${(it.price||0)*it.qty}</strong> CVE</li>`).join('');
    const total = (o.totalCVE != null) ? o.totalCVE : (o.items||[]).reduce((s,it)=>s+(it.price||0)*it.qty,0);
    return `<div class="order">
      <div class="row-spread"><h3>#${o.orderId} Â· Mesa: <span class="pill">${o.table||'-'}</span></h3><span class="badge confirmed">confirmado</span></div>
      <ul style="margin:8px 0 0 14px; padding:0 0 0 8px;">${items}</ul>
      <div class="row-spread" style="margin-top:8px;"><div></div><div class="total">Total: ${total} CVE</div></div>
      <div class="row" style="margin-top:8px;">
        <button class="btn btn-warn" data-done="${o.orderId}">Pronto</button>
      </div>
    </div>`;
  }
  function render(list){ document.getElementById('orders').innerHTML = list.map(rowHTML).join(''); }

  async function markDone(id){ try { await fb.updateDoc(fb.doc(fb.db,'orders', String(id)), { status:'ready', isReady:true, readyAt: Date.now() }); } catch(e){ console.warn('done error', e); } }
  document.addEventListener('click', (ev)=>{ const b = ev.target.closest('[data-done]'); if(b) markDone(b.getAttribute('data-done')); }, true);

  function handleSnapshot(snap){
    const list = []; snap.forEach(d=> { const o = Object.assign({}, d.data(), {orderId:d.id}); list.push(o); });
    const confirmed = list.filter(o=> o.status==='confirmed' || o.confirmed===true);
    confirmed.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
    snap.docChanges().forEach(ch=>{ if(ch.type==='added'){ if(soundOk) document.getElementById('sndCash').play().catch(()=>{}); } });
    render(confirmed);
  }

  const qref = fb.query(fb.collection(fb.db,'orders'));
  fb.onSnapshot(qref, handleSnapshot);
})();</script>
</body>
</html>
