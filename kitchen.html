
<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cozinha – Pedidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); }
    .btn  { padding:.6rem .9rem; border-radius:.9rem; font-weight:700; }
    .muted{ color:rgba(255,255,255,.75) }
    .pill { font-size:.75rem; padding:.15rem .5rem; border-radius:.5rem; background:#0b1226; border:1px solid rgba(255,255,255,.08); }
  </style>

<body class="p-4">
  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Cozinha – Pedidos</h1>
      <div class="flex items-center gap-2">
        <button id="soundBtn" class="btn bg-emerald-700 hover:bg-emerald-600">Som ativo</button>
        <button id="refreshBtn" class="btn bg-slate-700 hover:bg-slate-600">Atualizar</button>
      </div>
    </div>

    <div id="orders" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
  </div>

  <audio id="cashSound" preload="auto" src="cash.mp3"></audio>

  <script>
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  </script>

  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { 
    getFirestore, collection, doc, setDoc, addDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDoc 
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getStorage, ref as sRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

  // Using the same public config you shared in your files (client keys; safe for web apps)
  const firebaseConfig = {
    apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
    authDomain: "asabrancaff-faebe.firebaseapp.com",
    projectId: "asabrancaff-faebe",
    storageBucket: "asabrancaff-faebe.appspot.com",
    messagingSenderId: "326390762122",
    appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  signInAnonymously(auth).catch(()=>{});
  onAuthStateChanged(auth, ()=>{});

  // Expose for the page
  window.__fb = { app, db, auth, storage, collection, doc, setDoc, addDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, getDoc, sRef, getDownloadURL };
</script>


  <script type="module">
    const { db, storage, onSnapshot, query, where, orderBy, collection, doc, updateDoc, serverTimestamp, sRef, getDownloadURL } = window.__fb;

    // Try Storage for audio
    async function bindAudio(){ try{ const url = await getDownloadURL(sRef(storage,'cash.mp3')); document.getElementById('cashSound').src = url; }catch{} }
    bindAudio();

    const cashEl = document.getElementById('cashSound');
    let soundEnabled=false;
    document.getElementById('soundBtn').addEventListener('click', ()=>{
      cashEl.play().then(()=>{ cashEl.pause(); cashEl.currentTime=0; soundEnabled=true; }).catch(()=>{});
    });

    const ordersDiv = document.getElementById('orders');

    function render(list){
      ordersDiv.innerHTML='';
      if(!list.length){ ordersDiv.innerHTML='<p class="muted">Sem pedidos confirmados.</p>'; return; }
      list.forEach(o=>{
        const items = (o.items||[]).map(i=>`${i.qty||1} × ${esc(i.name||i.pizzaType||'')}`).join('<br>') || '(sem itens)';
        const when = o.confirmedAt?.toDate ? o.confirmedAt.toDate().toLocaleTimeString() : '';
        const card = document.createElement('div'); card.className='card p-3 rounded-xl';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold">Mesa ${esc(o.table)}</div>
              <div class="muted text-sm leading-5">${items}</div>
              ${o.notes?`<div class="text-sm mt-1">✍️ ${esc(o.notes)}</div>`:''}
              <div class="muted text-xs mt-1">Confirmado: ${when}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button class="btn bg-emerald-700 hover:bg-emerald-600" data-done="${o.id}">Marcar pronto</button>
            </div>
          </div>`;
        card.querySelector('[data-done]').addEventListener('click', ()=>markDone(o));
        ordersDiv.appendChild(card);
      });
    }

    async function markDone(o){
      try{
        await updateDoc(doc(collection(db,'orders'), o._docId), { isReady: true, readyAt: serverTimestamp(), updatedAt: serverTimestamp() });
      }catch(e){ console.warn(e); }
    }

    // Listen to confirmed orders only
    const ordersRef = collection(db,'orders');
    const qref = query(ordersRef, where('confirmed','==',true), where('rejectedAt','==',null), where('servedAt','==',null), orderBy('updatedAt','desc'));
    const state = new Map(); // id -> prev confirmed flag
    onSnapshot(qref, (snap)=>{
      const list = [];
      let play = false;
      snap.docChanges().forEach(ch=>{
        if (ch.type === 'added'){
          play = true;
        } else if (ch.type === 'modified'){
          const d = ch.doc.data(); const id = d.orderId || ch.doc.id;
          if (d.confirmed && !state.get(id)) play = true;
        }
      });
      snap.forEach(docSnap=>{
        const d = docSnap.data(); const id = d.orderId || docSnap.id;
        d.id = id; d._docId = docSnap.id;
        state.set(id, !!d.confirmed);
        list.push(d);
      });
      if (play && soundEnabled){ try{ cashEl.currentTime=0; cashEl.play().catch(()=>{});}catch{} }
      render(list);
    });

    document.getElementById('refreshBtn').addEventListener('click', ()=>location.reload());
  </script>

</body>
</html>
