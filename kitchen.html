<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cozinha — Pedidos</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#101010; color:#eee}
    header{padding:12px 16px; background:#1b1b1b; position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center}
    .badge{background:#2a2a2a; padding:6px 10px; border-radius:999px; font-size:12px}
    main{padding:16px; display:grid; gap:12px}
    .card{background:#1b1b1b; border:1px solid #2a2a2a; border-radius:12px; padding:12px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .items{margin:8px 0 0 16px}
    label{display:flex; align-items:center; gap:8px}
    .muted{opacity:.7; font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="badge">Cozinha</div>
    <div id="counts" class="badge">—</div>
    <audio id="cashSound" preload="auto">
      <source src="/cash.mp3" type="audio/mpeg">
      <source src="cash.mp3" type="audio/mpeg">
    </audio>
  </header>
  <main id="list"></main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
      authDomain: "asabrancaff-faebe.firebaseapp.com",
      projectId: "asabrancaff-faebe",
      storageBucket: "asabrancaff-faebe.appspot.com",
      messagingSenderId: "326390762122",
      appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const ordersRef = collection(db, "orders");

    const listEl = document.getElementById("list");
    const countsEl = document.getElementById("counts");
    const cashEl = document.getElementById("cashSound");

    // Prime sound (best effort)
    let primed = false;
    function primeSound(){
      if (primed) return; primed = true;
      cashEl.volume = 0;
      cashEl.play().then(()=>cashEl.pause()).catch(()=>{});
      cashEl.volume = 1;
    }
    async function playCash(){ primeSound(); try{ cashEl.currentTime = 0; await cashEl.play(); }catch{} }

    function esc(s){ const d=document.createElement("div"); d.textContent=String(s??""); return d.innerHTML; }
    function renderList(orders){
      listEl.innerHTML = "";
      if (!orders.length){
        listEl.innerHTML = '<div class="card muted">Sem pedidos confirmados.</div>';
        return;
      }
      for (const o of orders){
        const el = document.createElement("div");
        el.className = "card";
        const items = (Array.isArray(o.items)?o.items:[]).map(i=>`<li>${esc(i.qty??1)} × ${esc(i.name||i.item||i.pizzaType||"")}</li>`).join("") || '<li class="muted">—</li>';
        el.innerHTML = `
          <div class="row">
            <strong>Mesa ${esc(o.table??"?")}</strong>
            <label><input type="checkbox" data-action="ready" data-id="${o.id}" ${o.isReady?'checked':''}/> Pronto</label>
          </div>
          <ul class="items">${items}</ul>
          ${o.notes ? `<div class="muted">Notas: ${esc(o.notes)}</div>` : ''}
        `;
        listEl.appendChild(el);
      }
    }

    // Checkbox handler
    listEl.addEventListener("change", async (ev)=>{
      const cb = ev.target.closest("input[type=checkbox][data-action=ready]");
      if (!cb) return;
      const id = cb.getAttribute("data-id");
      const ref = doc(ordersRef, id);
      const isReady = cb.checked;
      try{
        await updateDoc(ref, { isReady, readyAtMs: isReady ? Date.now() : null });
      }catch(e){ console.error(e); }
    });

    let prevIds = new Set();

    onAuthStateChanged(auth, (u)=>{
      if (!u) return;
      onSnapshot(ordersRef, (snap)=>{
        const orders = [];
        let newCount = 0;
        const curIds = new Set();

        snap.forEach(docSnap=>{
          const d = docSnap.data()||{};
          const o = {
            id: String(docSnap.id),
            table: d.table ?? null,
            items: Array.isArray(d.items) ? d.items : [],
            notes: d.notes || "",
            createdAtMs: d.createdAtMs || 0,
            confirmed: !!d.confirmed,
            isReady: !!d.isReady,
            served: !!d.served
          };
          // Kitchen lists only confirmed & not served
          if (o.confirmed && !o.served){
            orders.push(o);
            curIds.add(o.id);
            if (!prevIds.has(o.id)) newCount++;
          }
        });

        orders.sort((a,b)=> (a.createdAtMs||0)-(b.createdAtMs||0) || a.id.localeCompare(b.id));
        renderList(orders);
        countsEl.textContent = `Ativos: ${orders.length}`;

        if (newCount > 0) playCash();
        prevIds = curIds;
      });
    });

    signInAnonymously(auth).catch(()=>{});
  </script>
</body>
</html>
