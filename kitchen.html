<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cozinha – Pedidos (Só Visualização)</title>
  <script src="https://cdn.tailwindcss.com"></script> 
<!-- <link rel="stylesheet" href="tailwind-lite.css"> -->
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); }
    .muted { color: rgba(255,255,255,0.7); }
    .btn  { padding:.55rem .85rem; border-radius:.75rem; font-weight:600; }
    .items li { list-style: disc; margin-left: 1.25rem; }
    details summary { cursor: pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/parse/dist/parse.min.js"></script>

  <script>
    try{
      Parse.initialize("90sppp5j95h77WJUAKKrSeVSFmRP2XgnUMxjzUaA", "B6F4JPeWDsVflznOWDEgD0IvVGxl2ZgtL5wycbcZ");
      Parse.serverURL="https://parseapi.back4app.com";
      Parse.liveQueryServerURL="wss://asabrancaff.b4a.io";
    }catch(e){ console && console.warn && console.warn('Parse init failed', e); }
  </script>

</head>
<body class="p-4">

<!-- EARLY_STRAY_FIX_V2 -->
<script>
(function(){
  try{
    function killStrays(root){
      try{
        var walker = document.createTreeWalker(root||document.body, NodeFilter.SHOW_TEXT, null);
        var toRemove = [];
        while (walker.nextNode()) {
          var n = walker.currentNode;
          if (!n) continue;
          var t = (n.nodeValue||'').trim();
          if (t === "\" || t === "\u0001" || t === "\x01" || t === "\\x01") toRemove.push(n);
        }
        toRemove.forEach(function(n){ try{ n.parentNode && n.parentNode.removeChild(n); }catch(e){} });
      }catch(e){}
    }
    if (document.body){ killStrays(document.body); }
    document.addEventListener('DOMContentLoaded', function(){ killStrays(document.body); }, {once:true});
  }catch(e){}
})();
</script>

  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Pedidos da Cozinha (Só Visualização)</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 cursor-pointer select-none flex items-center gap-2">
          <input id="hideServedChk" type="checkbox" /> Ocultar servidos
        </label>
        <button id="clearServedBtn" class="btn bg-slate-700 hover:bg-slate-600">Limpar servidos</button>
        <button id="soundBtn" class="btn bg-emerald-700 hover:bg-emerald-600">Som ativo</button>
      </div>
    </div>

    <div id="banner" class="hidden mb-3 p-3 rounded-xl bg-emerald-800/40 border border-emerald-700 text-sm">
      Novo pedido recebido!
    </div>

    <div id="orders" class="space-y-3 mb-6"></div>

   

  <!-- coloque cash.mp3 na mesma pasta ou troque por um URL -->
  <audio id="cashSound" preload="auto" src="cash.mp3"></audio>

  <script>
    "use strict";

    /* ====== Compatibilidade com dois formatos ====== */
    const KEYS = [
      { store: 'orders_simple_v4', version: 'orders_simple_v4_ver', channel: 'orders_simple_v4' },
      { store: 'orders',           version: 'orders_version',       channel: 'pizzaOrders' }
    ];

    function safeParse(json){ try { return JSON.parse(json || '[]'); } catch { return []; } }
    function uniqById(arr){
      const seen = new Set(); const out = [];
      for (const o of arr){
        const id = String((o && o.id) || o.createdAt || Math.random());
        if (!seen.has(id)){ seen.add(id); out.push(o); }
      }
      return out;
    }

    /* ====== CHANGED: only return CONFIRMED orders ====== */
    function getAllOrders(){
      const all = [];
      for (const k of KEYS) all.push(...safeParse(localStorage.getItem(k.store)));

      // Only orders confirmed by Staff should be visible to Kitchen.
      // Accept current shape (confirmed/confirmedAt) and legacy (status: 'confirmed').
      const confirmedOnly = all.filter(o => {
        const isConfirmed = o && (o.confirmed === true || !!o.confirmedAt || o.status === 'confirmed');
        return !!isConfirmed;
      });

      return uniqById(confirmedOnly).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    }

    /* ====== BroadcastChannels ====== */
    const channels = [];
    for (const k of KEYS){ try { channels.push(new BroadcastChannel(k.channel)); } catch {} }

    /* ====== UI refs ====== */
    const ordersDiv      = document.getElementById('orders');
    const banner         = document.getElementById('banner');
    const soundBtn       = document.getElementById('soundBtn');
    const cashEl         = document.getElementById('cashSound');
    const hideServedChk  = document.getElementById('hideServedChk');
    const clearServedBtn = document.getElementById('clearServedBtn');
    const histList       = document.getElementById('histList');
    const histTotalEl    = document.getElementById('histTotal');

    /* ====== Estado "Servido" (persistente) + versão ====== */
    const SERVED_KEY = 'orders_served';
    const SERVED_VERSION = 'orders_served_ver';
    function loadServed(){ try { return JSON.parse(localStorage.getItem(SERVED_KEY) || '{}'); } catch { return {}; } }
    function saveServed(map){
      localStorage.setItem(SERVED_KEY, JSON.stringify(map));
      localStorage.setItem(SERVED_VERSION, String(Date.now())); // trigger storage
    }
    let servedMap = loadServed();

    /* ====== Histórico (vincula quando marca “Servido”) ====== */
    const HISTORY_KEY = 'orders_history_v1';
    function getHistory(){ try { return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); } catch { return []; } }
    function setHistory(v){ localStorage.setItem(HISTORY_KEY, JSON.stringify(v)); }
    function formatCVE(n){ return `${Math.floor(Number(n)||0)}$00`; }

    function computeTotal(order){
      if (typeof order.totalNum === 'number'){
        return { num: order.totalNum, text: order.totalText || formatCVE(order.totalNum) };
      }
      let ok=false, sum=0;
      for (const it of (order.items||[])){
        if (typeof it.unitPrice === 'number'){ ok=true; sum += (it.unitPrice||0) * (Number(it.qty||1)); }
      }
      return ok ? { num: sum, text: formatCVE(sum) } : { num: null, text: null };
    }

    function ensureHistoryEntry(order, served){
      if (!served) return; // só regista quando fica servido
      const id = String(order.id);
      const hist = getHistory();
      if (!hist.some(h => String(h.id) === id)){
        const t = computeTotal(order);
        hist.push({
          id,
          table: order.table,
          createdAt: order.createdAt || Date.now(),
          servedAt: Date.now(),
          totalNum: t.num,
          totalText: t.text,
          items: (order.items||[]).map(i=>({ name: i.pizzaType||'', qty: Number(i.qty||1), unitPrice: i.unitPrice||null }))
        });
        setHistory(hist);
      }
      renderHistory(); // update panel
    }

    function isToday(ts){
      const d = new Date(ts || Date.now());
      const now = new Date();
      return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
    }

    function renderHistory(){
      const hist = getHistory().filter(h => isToday(h.servedAt || h.createdAt));
      histList.innerHTML = '';
      if (!hist.length){
        histList.innerHTML = '<p class="muted">Sem registos hoje.</p>';
      } else {
        let total = 0;
        hist.forEach(h=>{
          if (typeof h.totalNum === 'number') total += h.totalNum||0;
          const when = h.servedAt ? new Date(h.servedAt).toLocaleTimeString() : '';
          const ttxt = (h.totalText) ? h.totalText : (typeof h.totalNum==='number' ? formatCVE(h.totalNum) : '—');
          const div = document.createElement('div');
          div.className = 'card p-2 rounded-xl flex items-center justify-between';
          div.innerHTML = `
            <div>
              <div class="font-semibold">Mesa ${escapeHtml(h.table)}</div>
              <div class="muted text-xs">${when}</div>
            </div>
            <div class="font-semibold">${ttxt}</div>
          `;
          histList.appendChild(div);
        });
        histTotalEl.textContent = formatCVE(total);
      }
    }

    /* ====== Som (auto-ativado) ====== */
    let soundEnabled = false, audioCtx;
    async function enableSound(){
      soundEnabled = true;
      try { cashEl.volume = 1; cashEl.muted = false; cashEl.currentTime = 0; await cashEl.play(); cashEl.pause(); cashEl.currentTime = 0; } catch {}
      // teste curto silencioso
      try { await cashEl.play(); setTimeout(()=>{ try{ cashEl.pause(); }catch{} }, 200); } catch {}
    }
    async function playSound(){
      if (!soundEnabled) return;
      try { cashEl.currentTime = 0; await cashEl.play(); return; } catch {}
      playFallback();
    }
    function playFallback(){
      if (!soundEnabled) return;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!audioCtx && Ctx) audioCtx = new Ctx();
      if (!audioCtx) return;
      const now = audioCtx.currentTime, g = audioCtx.createGain();
      const o1 = audioCtx.createOscillator(), o2 = audioCtx.createOscillator();
      o1.type='square'; o2.type='square'; o1.frequency.value=800; o2.frequency.value=1600;
      o1.connect(g); o2.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.45, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.55);
      o1.start(now); o2.start(now+0.08); o1.stop(now+0.57); o2.stop(now+0.57);
    }
    soundBtn.addEventListener('click', enableSound);

    // tentar ativar som por omissão
    document.addEventListener('DOMContentLoaded', enableSound);
    document.addEventListener('pointerdown', ()=>{ if (!soundEnabled) enableSound(); }, { once:true });
    document.addEventListener('keydown', ()=>{ if (!soundEnabled) enableSound(); }, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible' && !soundEnabled) enableSound(); });

    /* ====== Utils ====== */
    function escapeHtml(str){
      return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function showBanner(count){
      banner.textContent = count === 1 ? 'Novo pedido recebido!' : `${count} novos pedidos recebidos!`;
      banner.classList.remove('hidden');
      clearTimeout(showBanner._t);
      showBanner._t = setTimeout(()=> banner.classList.add('hidden'), 3000);
    }

    /* ====== Notificar Staff quando "Servido" muda ====== */
    function notifyServed(id, served){
      channels.forEach(ch => {
        try { ch.postMessage({ type: 'served_update', id, served }); } catch {}
      });
      // storage "versão" já feito em saveServed()
    }

    /* ====== Render ====== */
    let knownIds = new Set();

    function render({withAlerts=true} = {}){
      const orders = getAllOrders(); // ← agora só confirmados
      const currIds = new Set(orders.map(o => String(o.id)));
      let novos = 0;
      currIds.forEach(id => { if (!knownIds.has(id)) novos++; });

      ordersDiv.innerHTML = '';
      const hideServed = hideServedChk.checked;

      if (!orders.length){
        ordersDiv.innerHTML = '<p class="muted">Sem pedidos ainda.</p>';
      } else {
        orders.forEach(o => {
          const id = String(o.id);
          const quando = o.createdAt ? new Date(o.createdAt).toLocaleString() : '';
          const isServed = !!servedMap[id];
          if (hideServed && isServed) return;

          const div = document.createElement('div');
          div.className = 'card p-3 rounded-xl';

          const items = Array.isArray(o.items) ? o.items : [];
          const itemsHTML = items.map(i => {
            const qty = Number(i.qty||1);
            const name = escapeHtml(i.pizzaType||'');
            const note = i.notes ? ` <span class="muted">(${escapeHtml(i.notes)})</span>` : '';
            return `<li>${qty} × ${name}${note}</li>`;
          }).join('') || '<li class="muted">—</li>';

          const t = (typeof o.totalNum === 'number') ? (o.totalText || formatCVE(o.totalNum)) : '';
          const left = document.createElement('div');
          left.innerHTML = `
            <div class="font-semibold">Mesa ${escapeHtml(o.table ?? '?')}</div>
            <ul class="items mt-2">${itemsHTML}</ul>
            ${o.notes ? `<div class='text-sm mt-2'>✍️ ${escapeHtml(o.notes)}</div>` : ''}
            ${t ? `<div class="mt-2"><span class="muted text-xs">Total:</span> <b>${t}</b></div>` : ''}
          `;

          const right = document.createElement('div');
          right.className = 'flex flex-col items-end gap-2';
          right.innerHTML = `<div class="muted text-xs">${quando}</div>`;

          const label = document.createElement('label');
          label.className = 'flex items-center gap-2 text-sm cursor-pointer select-none';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox'; checkbox.checked = isServed;
          checkbox.addEventListener('change', () => {
            servedMap[id] = checkbox.checked;
            saveServed(servedMap);

            notifyServed(id, checkbox.checked);
            ensureHistoryEntry(o, checkbox.checked);   // <— regista no histórico
            render({withAlerts:false});
          });

          label.appendChild(checkbox);
          label.appendChild(document.createTextNode('Pronto'));
          right.appendChild(label);

          const row = document.createElement('div');
          row.className = 'flex items-start justify-between gap-3';
          row.appendChild(left); row.appendChild(right);
          if (isServed) row.classList.add('opacity-50');

          div.appendChild(row);
          ordersDiv.appendChild(div);
        });
      }

      if (withAlerts && novos > 0){ showBanner(novos); playSound(); }
      knownIds = currIds;
      renderHistory();
    }

    /* ====== Eventos ====== */
    hideServedChk.addEventListener('change', ()=>render({withAlerts:false}));
    clearServedBtn.addEventListener('click', ()=>{
      const ids = Object.keys(servedMap).filter(id => servedMap[id]);
      if (!ids.length) { alert('Não há pedidos marcados como servidos.'); return; }
      if (!confirm(`Limpar marcação de ${ids.length} pedido(s)?`)) return;
      ids.forEach(id => delete servedMap[id]);
      saveServed(servedMap);
      render({withAlerts:false});
    });

    channels.forEach(ch => ch.onmessage = ()=> render({withAlerts:true}));
    window.addEventListener('storage', (e)=>{
      if (!e.key) return;
      if (['orders_simple_v4','orders_simple_v4_ver','orders_served_ver', 'orders_history_v1'].includes(e.key)){
        render({withAlerts:true});
      }
    });

    setInterval(()=>render({withAlerts:true}), 1000);
    render({withAlerts:false});

    /* ====== Som ====== */
    function playSound(){
      if (!soundEnabled) return;
      cashEl.currentTime = 0;
      cashEl.play().catch(playFallback);
    }
  </script>





<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCVpnh3u3zVs1cmZh-LTwHnite60XSxFbQ",
    authDomain: "asabrancaff-aa13d.firebaseapp.com",
    projectId: "asabrancaff-aa13d",
    storageBucket: "asabrancaff-aa13d.firebasestorage.app",
    messagingSenderId: "1031914620871",
    appId: "1:1031914620871:web:9df4a580400af8aea57be2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>





<!-- CLEAN_STRAY_BACKREF_V1 -->
<script>
(function(){
  function removeStray() {
    try{
      const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
      const toRemove = [];
      while (walker.nextNode()) {
        const n = walker.currentNode;
        if (!n) continue;
        const t = (n.nodeValue||'').trim();
        if (t === "\" || t === "\x01" || t === "\u0001") toRemove.push(n);
      }
      toRemove.forEach(n=>{ try{ n.parentNode && n.parentNode.removeChild(n); }catch(e){} });
    }catch(e){}
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', removeStray);
  else removeStray();
})();
</script>


<!-- SOUND_PRIME_KITCHEN_V1 -->
<script>
(function(){
  try{ window.soundEnabled = true; }catch(_e){}
  function prime(){
    try{
      var ids = ['cashSound','alertSound','doneSound'];
      ids.forEach(function(id){
        var el = document.getElementById(id);
        if (!el) return;
        try{ el.muted = false; }catch(e){}
        var p = el.play();
        if (p && typeof p.then==='function') { p.then(function(){ try{ el.pause(); el.currentTime = 0; }catch(e){} }).catch(function(){}); }
      });
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', prime, {once:true});
  ['pointerdown','touchstart','keydown'].forEach(function(evt){ window.addEventListener(evt, function(){ try{ prime(); }catch(e){} }, {once:true, passive:true, capture:true}); });
})();
</script>


<!-- SOUND_UI_ON_KITCHEN_V1 -->
<script>
(function(){
  function activateSoundBtn(){
    try{
      var btn = document.getElementById('soundBtn');
      if (!btn) return;
      btn.setAttribute('aria-pressed', 'true');
      btn.dataset.on = '1';
      btn.classList.add('ring-2','ring-emerald-400','shadow-inner');
    }catch(e){}
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', activateSoundBtn);
  else activateSoundBtn();
  try{ if (typeof enableSound === 'function') document.addEventListener('DOMContentLoaded', enableSound); }catch(e){}
})();
</script>

</body>
</html>
