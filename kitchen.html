<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cozinha – Pedidos (Só Visualização)</title>
  <script src="https://cdn.tailwindcss.com"></script> 
<!-- <link rel="stylesheet" href="tailwind-lite.css"> -->
  <style>
    :root { color-scheme: dark; }
    body { background:#0b1020; color:#fff; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,0.08); }
    .muted { color: rgba(255,255,255,0.7); }
    .btn  { padding:.55rem .85rem; border-radius:.75rem; font-weight:600; }
    .items li { list-style: disc; margin-left: 1.25rem; }
    details summary { cursor: pointer; }
  </style>


  

</head>
<body class="p-4">
  <div class="max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-bold">Pedidos da Cozinha (Só Visualização)</h1>
      <div class="flex flex-wrap items-center gap-2">
        
          </div>
        </div>`;
      ordersDiv.appendChild(div);
    });
    ordersDiv.querySelectorAll('[data-ready]').forEach(cb=>{
      cb.addEventListener('change', (ev)=>{
        const id = ev.target.getAttribute('data-ready');
        try{
          const ref = fb.doc(fb.db, 'orders', String(id));
          fb.updateDoc(ref, { isReady: ev.target.checked, readyAtMs: Date.now() });
        }catch(e){ console.warn('Kitchen update error', e); }
      });
    });
  }

  const qConf = fb.query(fb.ordersCol, fb.where('confirmed','==',true), fb.orderBy('createdAtMs','asc'));
  fb.onSnapshot(qConf, (snap)=>{
    const list=[]; let novos=0;
    snap.forEach(doc=>{
      const d=doc.data()||{};
      list.push({ id:d.id || doc.id, table:d.table, items:d.items||[], notes:d.notes||'', totalCVE:d.totalCVE, createdAt:d.createdAtMs||Date.now(), isReady:!!d.isReady, readyAt:d.readyAtMs||null });
      if (!knownIds.has(d.id||doc.id)) novos++;
    });
    renderList(list);
    if (novos>0){ try{ banner.classList.remove('hidden'); setTimeout(()=>banner.classList.add('hidden'), 2000); }catch{}; playSound(); }
    knownIds = new Set(list.map(o=>String(o.id)));
  });
    return true;
  }
  if (!init()){
    let tries=0; const t=setInterval(()=>{ if(init()){clearInterval(t);} else if(++tries>50){clearInterval(t); console.warn('Firebase still not ready; gave up starting listeners.');}}, 200);
  }
})();
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

  const firebaseConfig = {
  apiKey: "AIzaSyBTYSRTrdY-vml4LdsIYxYQfQt0K2GbReM",
  authDomain: "asabrancaff-faebe.firebaseapp.com",
  projectId: "asabrancaff-faebe",
  storageBucket: "asabrancaff-faebe.appspot.com",
  messagingSenderId: "326390762122",
  appId: "1:326390762122:web:919c53bd8d0cf9c34dbb73"
};
window.firebaseConfig = firebaseConfig;

  const app = initializeApp(window.firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

window.__fb = { app, db, auth, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where,
        ordersCol: collection(db, "orders")
      };
window.__fbReady = false;
onAuthStateChanged(auth, (u)=>{ if (u) { window.__fbReady = true; } });
signInAnonymously(auth).catch(()=>{});
</script>


<script>
  (function(){
    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
    async function start(){
      for (let i=0;i<50 && (!window.__fbReady || !window.__fb); i++) await delay(200);
      const fb = window.__fb; if (!fb) { console.warn('Kitchen: fb not ready.'); return; }
      const { onSnapshot, ordersCol } = fb;
      if (typeof renderList !== 'function'){
        window.renderList = function(list){ const listEl=document.getElementById('list'); listEl.innerHTML = list.map(o=>`<div class="card"><div class="row"><strong>Mesa ${o.table??'?'}</strong><label class="switch"><input type="checkbox" data-action="ready" data-id="${o.id}" ${o.isReady?'checked':''}/> Pronto</label></div><ul class="items">${(o.items||[]).map(i=>`<li>${i.qty||1} × ${i.name||i.item||i.pizzaType||''}${i.category?` <span class="muted">(${i.category})</span>`:''}</li>`).join('')}</ul>${o.notes?`<div class="muted">Notas: ${o.notes}</div>`:''}</div>`).join(''); };
      }
      onSnapshot(ordersCol, (snap)=>{
        const orders=[];
        snap.forEach(doc=>{
          const d=doc.data()||{};
          const o = { id:String(doc.id), table:d.table??null, items:Array.isArray(d.items)?d.items:[], notes:d.notes||'', createdAtMs:d.createdAtMs||0, confirmed:!!d.confirmed, isReady:!!d.isReady, served:!!d.served };
          if (o.confirmed && !o.served) orders.push(o);
        });
        orders.sort((a,b)=>(a.createdAtMs||0)-(b.createdAtMs||0) || a.id.localeCompare(b.id));
        try{ renderList(orders); }catch(e){ console.error(e); }
        const countsEl = document.getElementById('counts'); if (countsEl) countsEl.textContent = 'Ativos: '+orders.length;
      });
    }
    start();
  })();
</script>
</body>
</html>
